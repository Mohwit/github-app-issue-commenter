<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_name }} - Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">ü§ñ</div>
                    <div>
                        <h1>{{ app_name }}</h1>
                        <p class="subtitle">Monitor all new issues across your repositories</p>
                    </div>
                </div>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-issues">{{ total_issues }}</div>
                        <div class="stat-label">Total Issues</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-repos">-</div>
                        <div class="stat-label">Repositories</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Search and Filter -->
        <div class="controls">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="search" placeholder="Search issues by title, repository, or user...">
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="today">Today</button>
                <button class="filter-btn" data-filter="week">This Week</button>
            </div>
        </div>

        <!-- Issues List -->
        <div class="issues-container">
            <div class="issues-header">
                <h2>Recent Issues</h2>
                <button class="refresh-btn" onclick="loadIssues()">üîÑ Refresh</button>
            </div>
            
            <div id="issues-list" class="issues-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading issues...</p>
                </div>
            </div>

            <div id="no-issues" class="no-issues" style="display: none;">
                <div class="no-issues-icon">üì≠</div>
                <h3>No issues yet</h3>
                <p>When new issues are created in your repositories, they'll appear here.</p>
            </div>
        </div>
    </div>

    <script>
        let allIssues = [];
        let currentFilter = 'all';

        // Load issues from API
        async function loadIssues() {
            try {
                const response = await fetch('/api/issues');
                const data = await response.json();
                allIssues = data.issues;
                
                // Update stats
                document.getElementById('total-issues').textContent = data.total;
                const uniqueRepos = new Set(allIssues.map(issue => issue.repository));
                document.getElementById('active-repos').textContent = uniqueRepos.size;
                
                displayIssues(allIssues);
            } catch (error) {
                console.error('Error loading issues:', error);
                document.getElementById('issues-list').innerHTML = `
                    <div class="error">
                        <p>‚ùå Failed to load issues</p>
                    </div>
                `;
            }
        }

        // Display issues
        function displayIssues(issues) {
            const issuesList = document.getElementById('issues-list');
            const noIssues = document.getElementById('no-issues');
            
            if (issues.length === 0) {
                issuesList.style.display = 'none';
                noIssues.style.display = 'flex';
                return;
            }
            
            issuesList.style.display = 'block';
            noIssues.style.display = 'none';
            
            issuesList.innerHTML = issues.map(issue => `
                <div class="issue-card">
                    <div class="issue-header">
                        <div class="issue-user">
                            <img src="${issue.user_avatar || 'https://github.com/ghost.png'}" 
                                 alt="${issue.user}" 
                                 class="user-avatar">
                            <span class="username">${issue.user}</span>
                        </div>
                        <span class="issue-time">${formatTime(issue.timestamp)}</span>
                    </div>
                    
                    <div class="issue-content">
                        <div class="issue-title-row">
                            <a href="${issue.url}" target="_blank" class="issue-title">
                                ${escapeHtml(issue.title)}
                            </a>
                            <span class="issue-number">#${issue.number}</span>
                        </div>
                        
                        <div class="issue-repo">
                            <span class="repo-icon">üì¶</span>
                            <span>${issue.repository}</span>
                        </div>
                        
                        ${issue.body ? `<p class="issue-body">${escapeHtml(issue.body)}</p>` : ''}
                        
                        ${issue.labels && issue.labels.length > 0 ? `
                            <div class="issue-labels">
                                ${issue.labels.map(label => `
                                    <span class="label">${escapeHtml(label)}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="issue-footer">
                        <a href="${issue.url}" target="_blank" class="view-btn">
                            View on GitHub ‚Üí
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // Search functionality
        document.getElementById('search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allIssues.filter(issue => 
                issue.title.toLowerCase().includes(searchTerm) ||
                issue.repository.toLowerCase().includes(searchTerm) ||
                issue.user.toLowerCase().includes(searchTerm) ||
                (issue.body && issue.body.toLowerCase().includes(searchTerm))
            );
            displayIssues(filtered);
        });

        // Filter functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                currentFilter = btn.dataset.filter;
                const filtered = filterIssuesByTime(allIssues, currentFilter);
                displayIssues(filtered);
            });
        });

        function filterIssuesByTime(issues, filter) {
            if (filter === 'all') return issues;
            
            const now = new Date();
            return issues.filter(issue => {
                const issueDate = new Date(issue.timestamp);
                const diffTime = Math.abs(now - issueDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (filter === 'today') return diffDays <= 1;
                if (filter === 'week') return diffDays <= 7;
                return true;
            });
        }

        // Helper functions
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined 
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-refresh every 30 seconds
        setInterval(loadIssues, 30000);

        // Initial load
        loadIssues();
    </script>
</body>
</html>

